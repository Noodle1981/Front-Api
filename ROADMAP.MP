 Olvidamos el concepto de "CRM de Ventas" (adi√≥s leads, scoring, pipelines) y nos enfocamos en un Gestor de Integraciones (Middleware Hub) para un estudio contable.
Tu objetivo es construir la interfaz para que el estudio contable gestione las credenciales de sus clientes. El backend (equipo de datos) usar√° esas credenciales guardadas para ir a buscar la data (facturas, pagos, etc.).
Aqu√≠ est√° la propuesta de refactorizaci√≥n adaptada a este nuevo enfoque:
Etapa 1. Limpieza del Proyecto ("De-bloating")
Dado que partimos de una base CRM, primero eliminamos lo que sobra para no confundir:
Eliminar: L√≥gica de Lead Scoring, Estados de "Lead" (prospecto, convertido, etc.), Tableros Kanban.
Mantener: User (Auth), Roles, Client (ahora visto como la empresa/persona a la que el estudio le lleva los n√∫meros).
Etapa 2. Arquitectura de Datos: El problema de "APIs diferentes"
Para resolver tu duda de "¬øc√≥mo hago con el tema de las APIs si todas piden datos distintos?", la mejor soluci√≥n en Laravel es usar el patr√≥n de Cat√°logo vs. Instancia apoy√°ndonos en columnas JSON y Encriptaci√≥n.
No crees una tabla mercado_pago_configs y otra afip_configs. Hazlo gen√©rico.
Nuevos Modelos Propuestos:
A. Modelo ApiService (El Cat√°logo / CRUD de APIs)
Aqu√≠ el Administrador define qu√© APIs soporta el sistema.
id
name: "Mercado Pago", "AFIP", "Tienda Nube".
slug: "mercado-pago".
base_url: La URL base de la API (opcional).
required_fields: (CLAVE) Una columna JSON donde defines qu√© campos necesita esta API.
Ejemplo para MP: ["access_token", "public_key"]
Ejemplo para Otra: ["api_key", "secret_id", "region"]
B. Modelo ClientCredential (La Conexi√≥n)
Aqu√≠ guardas la relaci√≥n entre el Cliente y la API, junto con sus claves.
id
client_id: Relaci√≥n con el Cliente.
api_service_id: Relaci√≥n con el ApiService (ej. Mercado Pago).
credentials: (CLAVE) Columna JSON ENCRIPTADA que guarda los valores reales.
is_active: Boolean.
Etapa 3. Implementaci√≥n T√©cnica (C√≥mo funciona la magia)
Paso 1: Definir los campos variables
Cuando el Admin crea la API "Mercado Pago" en el CRUD de APIs, en un campo de texto (o una UI din√°mica sencilla) define que necesita public_key y access_token.
Paso 2: El formulario din√°mico (Front-end)
Cuando el Usuario va a un Cliente y le da a "Conectar Mercado Pago":
Tu Front lee api_service->required_fields.
Con un bucle foreach en Blade/Alpine, dibujas un <input> por cada campo requerido.
El usuario pega las claves.
Paso 3: Guardado Seguro (Back-end)
Esto es vital. Como es un estudio contable, no puedes guardar tokens en texto plano. Si hackean la DB, roban el acceso a las cuentas de los clientes.
En tu modelo ClientCredential:
code
PHP
// app/Models/ClientCredential.php
use Illuminate\Database\Eloquent\Casts\AsEncryptedArrayObject;

class ClientCredential extends Model
{
    protected $casts = [
        // Laravel encripta/desencripta autom√°ticamente al guardar/leer
        'credentials' => AsEncryptedArrayObject::class, 
    ];
}
Etapa 4. Roles y Flujo de Trabajo
Rol Admin (IT / Tech Lead):
Tiene acceso al CRUD de APIs (ApiService).
Define: "Hoy agregamos soporte para Mercado Pago". Configura los campos que se pedir√°n.
Rol Contador/Operador:
Tiene acceso al CRUD de Clientes.
Entra al perfil de "Cliente Juan P√©rez".
Ve una pesta√±a "Integraciones".
Selecciona "Mercado Pago" -> El sistema le pide los tokens -> Guarda.
El Equipo de Backend (Consumidores):
Crear√°s un endpoint interno o un Comando que ellos usar√°n.
Ejemplo: ClientCredential::where('client_id', 1)->get(). Laravel desencripta las claves autom√°ticamente y ellos ya pueden hacer los GET a Mercado Pago.
5. ¬øC√≥mo empezar la refactorizaci√≥n?
Limpieza: Borra todo lo relacionado a "pipeline" o "funnel".
Migraciones:
Crea la tabla api_services (name, required_fields [json]).
Crea la tabla client_credentials (client_id, api_service_id, credentials [text/longtext]).
CRUD APIs: Haz un ABM simple donde puedas crear "Mercado Pago" y definir sus campos requeridos en un JSON simple.
Vista Cliente: En la vista de detalle del Cliente, agrega la secci√≥n para agregar credenciales din√°micamente.

Etapa 5. 


Esta migraci√≥n que muestras tiene una mezcla de conceptos del proyecto anterior ("CRM de H&S") con lo que necesitas ahora. Vamos a limpiarla y adaptarla al contexto de Estudio Contable / Gestor de APIs.
1. Sobre tu pregunta: ¬øSoftDeletes?
S√ç, ABSOLUTAMENTE.
En sistemas contables o de gesti√≥n de datos cr√≠ticos, nunca se borra informaci√≥n.
Auditor√≠a: Si el backend falla procesando datos de un cliente que "ya no existe", necesitas saber qui√©n era.
Regreso del Cliente: Es muy com√∫n que una empresa se vaya y vuelva al a√±o siguiente. Con SoftDeletes, solo "restauras" al cliente y mantienes su historial y sus configuraciones de API viejas (que quiz√°s solo necesiten renovar token).
Integridad Referencial: Si borras un cliente "f√≠sicamente" (hard delete), podr√≠as romper registros hist√≥ricos de logs o credenciales.
2. An√°lisis de los Campos para un Estudio Contable
Para un Hub de Integraciones Contables, necesitas identificar inequ√≠vocamente a la empresa fiscal.
Lo que est√° bien: cuit (Es tu ID real), company (Raz√≥n Social), fiscal_address.
Lo que sobra o confunde: Los campos de ART y H&S (art_provider, hs_manager...) suenan a "Higiene y Seguridad". Si el estudio contable NO hace liquidaci√≥n de sueldos ni RRHH, estos campos sobran. Si solo les vas a gestionar las facturas (Mercado Pago, AFIP), b√≥rralos.
Lo que falta:
tax_condition: (Responsable Inscripto, Monotributo, Exento). Es vital para saber qu√© APIs o endpoints usar.
uuid: Es buena pr√°ctica exponer un UUID en lugar del ID num√©rico si vas a conectar sistemas externos.
3. Migraci√≥n Refactorizada
Aqu√≠ tienes la versi√≥n limpia, enfocada en Contabilidad/APIs y con SoftDeletes.
code
PHP
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration
{
    public function up(): void
    {
        Schema::create('clients', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique()->comment('Identificador p√∫blico para sistemas externos');

            // --- Identificaci√≥n Fiscal (Lo m√°s importante) ---
            $table->string('cuit', 11)->unique()->comment('Clave √önica de Identificaci√≥n Tributaria (sin guiones)');
            $table->string('company')->comment('Raz√≥n Social (Nombre legal en facturas)');
            $table->string('fantasy_name')->nullable()->comment('Nombre de fantas√≠a / Marca comercial');
            
            // --- Clasificaci√≥n Contable ---
            // Ejemplo: 'responsable_inscripto', 'monotributo', 'exento'
            $table->string('tax_condition')->nullable()->comment('Condici√≥n frente al IVA'); 

            // --- Contacto Principal (Para avisar si se cae una API) ---
            $table->string('email')->nullable()->comment('Email para notificaciones de sistema/alertas');
            $table->string('phone')->nullable();
            $table->string('website')->nullable();
            
            // --- Domicilio Fiscal ---
            $table->string('address')->nullable();
            $table->string('city')->nullable();
            $table->string('state')->nullable(); // Provincia
            $table->string('zip_code')->nullable();

            // --- Gesti√≥n Interna y Auditor√≠a ---
            $table->text('internal_notes')->nullable()->comment('Notas internas del estudio contable');
            
            // ID externo si vienen de otro sistema (H&S o sistema legacy del estudio)
            $table->unsignedBigInteger('external_reference_id')->nullable()->index()->comment('ID de referencia si se import√≥ de otro sistema');

            // Asignaci√≥n de Responsable
            $table->foreignId('user_id')
                  ->nullable()
                  ->constrained('users')
                  ->onDelete('set null')
                  ->comment('Contador o gestor asignado a este cliente');

            $table->boolean('is_active')->default(true)->comment('Switch r√°pido para desactivar acceso a APIs sin borrar');
            
            $table->timestamps();
            $table->softDeletes(); // <--- Aqu√≠ est√° la magia para no borrar datos
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('clients');
    }
};
Cambios Clave que hice:
Limpieza de Nombres: Cambi√© name por fantasy_name y dej√© company como la Raz√≥n Social. Esto evita confusiones contables.
cuit como string de 11: En Argentina el CUIT son 11 n√∫meros. Es mejor guardarlo sin guiones para buscar f√°cil.
SoftDeletes: Agregado al final. Recuerda agregar el trait use SoftDeletes; en tu modelo Client.
is_active vs SoftDelete:
SoftDelete = El cliente rescindi√≥ contrato (Baja).
is_active = El cliente no pag√≥ este mes, le "apago" el uso de las APIs temporalmente, pero sigue siendo cliente.
Relaci√≥n User: Le puse nullable y onDelete('set null'). Si despides al contador (User), no querr√°s que se borren sus clientes ni que explote la base de datos. Simplemente, el campo queda vac√≠o hasta que asignes otro.

etapa 6

Rubro (industry)
Empleados (employees_count)
Sede / Anexo (L√≥gica de parent_id)
‚ö†Ô∏è ATENCI√ìN AL CUIT:
Tuve que quitarle el unique() al CUIT.
¬øPor qu√©? Porque si carg√°s la Casa Central (CUIT X) y despu√©s quer√©s cargar el Anexo (mismo CUIT X), si dej√°s el unique, la base de datos te va a dar error. Ahora solo tiene index() para que busque r√°pido, pero permite repetidos (para las sucursales).
Ac√° ten√©s la migraci√≥n lista para copiar y pegar:
code
PHP
<?php

use Illuminate\Database\Migrations\Migration;
use Illuminate\Database\Schema\Blueprint;
use Illuminate\Support\Facades\Schema;

return new class extends Migration {
    public function up(): void
    {
        Schema::create('clients', function (Blueprint $table) {
            $table->id();
            $table->uuid('uuid')->unique()->comment('Identificador p√∫blico para sistemas externos');

            // --- NUEVO: L√≥gica Sede vs Anexo ---
            // Si est√° vac√≠o (NULL) es la CASA CENTRAL. Si tiene un ID, es un ANEXO de esa central.
            $table->foreignId('parent_id')
                  ->nullable()
                  ->constrained('clients')
                  ->onDelete('cascade')
                  ->comment('Jerarqu√≠a: NULL = Sede, ID = Anexo/Sucursal');
                  
            $table->string('branch_name')->nullable()->comment('Nombre de la sucursal si es anexo (Ej: Local Centro)');

            // --- Identificaci√≥n Fiscal ---
            // CAMBIO IMPORTANTE: Quitamos 'unique()' para permitir cargar sucursales con mismo CUIT
            $table->string('cuit', 11)->index()->comment('CUIT (sin guiones). No es √∫nico para permitir sucursales.');
            
            $table->string('company')->comment('Raz√≥n Social (Nombre legal en facturas)');
            $table->string('fantasy_name')->nullable()->comment('Nombre de fantas√≠a / Marca comercial');

            // --- Clasificaci√≥n Contable y Datos de Negocio ---
            $table->string('tax_condition')->nullable()->comment('Condici√≥n frente al IVA');
            
            // --- NUEVO: Lo que pediste reci√©n ---
            $table->string('industry')->nullable()->comment('Rubro (Ej: Gastronom√≠a, Salud)');
            $table->integer('employees_count')->nullable()->unsigned()->comment('Cantidad de empleados');

            // --- Contacto Principal ---
            $table->string('email')->nullable()->comment('Email para notificaciones');
            $table->string('phone')->nullable();
            $table->string('website')->nullable();

            // --- Domicilio Fiscal ---
            $table->string('address')->nullable();
            $table->string('city')->nullable();
            $table->string('state')->nullable(); 
            $table->string('zip_code')->nullable();

            // --- Gesti√≥n Interna ---
            $table->text('internal_notes')->nullable();
            $table->unsignedBigInteger('external_reference_id')->nullable()->index();

            $table->foreignId('user_id')
                ->nullable()
                ->constrained('users')
                ->onDelete('set null')
                ->comment('Contador asignado');

            $table->boolean('active')->default(true); // Mantengo 'active' como en tu c√≥digo original

            $table->timestamps();
            $table->softDeletes();
        });
    }

    public function down(): void
    {
        Schema::dropIfExists('clients');
    }
};
Resumen de los agregados:
parent_id: Es el campo m√°gico. Si cre√°s un cliente y dej√°s esto vac√≠o, es una empresa normal (Sede). Si le pon√©s el ID de otro cliente, se convierte en "Anexo" de ese cliente.
branch_name: Para ponerle nombre al anexo (ej: "Dep√≥sito", "Local 2").
industry: Aqu√≠ guard√°s el Rubro.
employees_count: Aqu√≠ guard√°s la Cantidad de Empleados.
cuit: Pas√≥ de ser unique() a index(). Esto es vital para que no te explote el sistema cuando cargues dos locales de la misma empresa.

etapa 7

Esta es una decisi√≥n de arquitectura cr√≠tica. Para que el sistema sea seguro y no se rompa, debemos separar claramente **qui√©n configura las reglas del juego** (Definiciones de API) de **qui√©n juega** (Carga de datos).

Te propongo una estructura de **3 Roles** para mantener el orden.

### La Filosof√≠a: "Definici√≥n" vs "Uso"
El punto clave para responder tu duda sobre las APIs es entender la diferencia entre:
1.  **Definir la API (Cat√°logo):** Decir "El sistema soporta Mercado Pago y necesita `client_id` y `secret`". -> **Esto rompe el sistema si se hace mal.**
2.  **Usar la API (Credenciales):** Decir "El Cliente Juan P√©rez tiene el secret `abc-123`". -> **Esto es trabajo diario.**

---

### Distribuci√≥n de Roles Propuesta

#### 1. Rol: `SUPER ADMIN` (IT / Tech Lead)
Es el "Dios" del sistema. Probablemente seas t√∫ o el jefe de tecnolog√≠a.
*   **Gesti√≥n de Usuarios:** Crea, edita y elimina a los empleados (Contadores).
*   **Gesti√≥n de APIs (Cat√°logo - `ApiService`):**
    *   Es el **√öNICO** que puede crear/editar/borrar en la tabla `api_services`.
    *   Define qu√© campos JSON se piden (ej: define que para "AFIP" se pide certificado y clave).
    *   *Por qu√©:* Si un usuario normal borra "Mercado Pago" del cat√°logo, se rompen las integraciones de 500 clientes.
*   **Acceso Global:** Puede ver y editar cualquier cliente si hay una emergencia.

#### 2. Rol: `MANAGER` (Gerente del Estudio / Supervisor)
Es el jefe de los contadores. No toca c√≥digo ni configuraciones t√©cnicas.
*   **Gesti√≥n de Clientes:**
    *   Puede Reasignar clientes (mover un cliente del Contador A al Contador B).
    *   Puede ver Reportes (cu√°ntos clientes hay, qui√©n carg√≥ qu√©).
    *   Puede Restaurar clientes eliminados (SoftDeletes).
*   **Usuarios:** Puede ver la lista de empleados, pero no crear nuevos (opcional).

#### 3. Rol: `ANALISTA` (Contador / Usuario Est√°ndar)
Es el usuario que trabaja d√≠a a d√≠a cargando datos.
*   **Gesti√≥n de Clientes:**
    *   **Create/Read/Update:** Crea clientes, carga sus datos (CUIT, Empleados, etc.).
    *   **Delete:** No deber√≠a poder borrar permanentemente. Solo "Desactivar" o SoftDelete.
*   **Gesti√≥n de APIs (Credenciales - `ClientCredential`):**
    *   **Read (Cat√°logo):** Solo puede *ver* la lista de APIs disponibles ("Ah, puedo conectar MP o AFIP"). **No puede crear nuevas APIs.**
    *   **Create/Update (Credenciales):** Es quien hace la conexi√≥n. Entra al perfil de "Ferreter√≠a Juan", selecciona "Mercado Pago" y pega los tokens que le pas√≥ el cliente.

---

### Resumen de Permisos (Matriz CRUD)

| Recurso / Acci√≥n | Super Admin | Manager | Analista (User) |
| :--- | :---: | :---: | :---: |
| **Usuarios** (Crear login) | ‚úÖ FULL | üëÅÔ∏è Ver | ‚ùå |
| **Cat√°logo APIs** (Definir estructura) | ‚úÖ FULL | üëÅÔ∏è Ver | üëÅÔ∏è Ver (Solo lista) |
| **Clientes** (Datos, CUIT) | ‚úÖ FULL | ‚úÖ FULL | ‚úÖ (Sin Borrado Final) |
| **Credenciales** (Cargar Tokens del cliente) | ‚úÖ FULL | üëÅÔ∏è Ver | ‚úÖ Cargar y Editar |

### ¬øC√≥mo implementar esto en c√≥digo?

Dado que est√°s usando Laravel 12, te recomiendo encarecidamente usar el paquete **`spatie/laravel-permission`**. Es el est√°ndar de la industria.

**Ejemplo de c√≥mo se ver√≠a la protecci√≥n en tus Rutas o Controladores:**

```php
// Rutas protegidas para configuraci√≥n del sistema
Route::middleware(['role:super-admin'])->group(function () {
    Route::resource('users', UserController::class);
    Route::resource('api-services', ApiServiceController::class); // <-- NADIE M√ÅS ENTRA AC√Å
});

// Rutas operativas (el d√≠a a d√≠a)
Route::middleware(['role:analista|manager|super-admin'])->group(function () {
    Route::resource('clients', ClientController::class);
    
    // El analista puede guardar credenciales, pero NO crear servicios nuevos
    Route::post('clients/{client}/credentials', [ClientCredentialController::class, 'store']);
});
```

### Respuesta a tu miedo: "¬øPara que no vayan a romper nada?"

Con esta estructura:
1.  El **Analista** nunca entra al men√∫ "Configuraci√≥n de APIs". Solo ve un dropdown en la ficha del cliente que dice "Conectar Servicio".
2.  Si el Analista se equivoca cargando un token, solo rompe la conexi√≥n de **ESE** cliente, no de todo el sistema.
3.  Solo el **Admin** puede tocar la estructura JSON que define c√≥mo funciona la API.

Etapa 8  


Contexto del Proyecto:
Estoy desarrollando un "Hub de Integraciones Contables" (Accounting Middleware) usando Laravel 12, Blade, Tailwind CSS y Alpine.js. Ya tengo implementado el sistema de Usuarios y Clientes (clients).
Objetivo:
Necesito implementar el "M√≥dulo de Gesti√≥n de APIs y Datos". Esto tiene dos partes fundamentales:
Centro de Control de APIs: Un dashboard para monitorear el estado de las conexiones (logs, errores, health check).
Almacenamiento de Datos (Transactions): Una estructura para guardar la informaci√≥n financiera que el backend descarga de las APIs (Mercado Pago, AFIP, Bancos) y mostrarla al usuario, evitando usar Excel como almacenamiento (el Excel ser√° solo para exportar).
Por favor, genera las Migraciones, Modelos y Vistas (Blade) siguiendo estas especificaciones:
1. Base de Datos (Migraciones)
Necesito 2 tablas nuevas. Usa foreignId y restricciones adecuadas.
Tabla A: api_logs (Bit√°cora de Eventos)
Esta tabla registrar√° qu√© pas√≥ cuando el backend intent√≥ conectarse.
client_id: Relaci√≥n con el cliente.
api_service_id: Relaci√≥n con el servicio (ej: Mercado Pago).
status: Enum ('success', 'warning', 'error', 'pending').
event_type: String (Ej: "Sincronizaci√≥n Facturas", "Token Refresh").
details: Text/JSON (Para guardar el mensaje de error t√©cnico si falla).
happened_at: Timestamp.
Tabla B: transactions (Datos Financieros Unificados)
Aqu√≠ se guardar√°n los datos reales descargados. No quiero guardar archivos, quiero guardar filas de datos.
client_id: Relaci√≥n con el cliente.
api_service_id: De d√≥nde vino el dato.
date_at: DateTime (Fecha real del movimiento).
amount: Decimal (15, 2).
currency: String (default 'ARS').
type: Enum ('income', 'expense').
description: String (Ej: "Cobro MP #1234").
status: Enum ('pending', 'verified', 'rejected') (Para control del contador).
raw_data: JSON (Campo cr√≠tico para guardar la data cruda espec√≠fica de cada API que no encaje en las columnas est√°ndar).
2. Modelos y Relaciones
Genera los modelos ApiLog y Transaction con sus relaciones:
Un Client tiene muchos ApiLogs y muchas Transactions.
Aseg√∫rate de incluir casts para los campos JSON y fechas.
3. Vistas (Blade + Tailwind)
Vista A: "Centro de APIs" (Dashboard T√©cnico)
Crea una vista que funcione como "Torre de Control". Debe tener 3 secciones visuales:
Tarjetas de Estado (Health Check): Arriba. Muestra contadores (Total Errores hoy, Sincronizaciones Exitosas, Clientes Conectados).
Bit√°cora en Vivo (Live Feed): Al centro/izquierda. Una tabla mostrando los √∫ltimos ApiLogs. Si el status es 'error', la fila o badge debe ser roja. Si es 'success', verde.
Cat√°logo de Servicios: A la derecha. Una lista de las APIs disponibles indicando si son de tipo "Autom√°tico" (ü§ñ) o "Manual" (üìÇ).
Vista B: "Listado de Movimientos" (En el perfil del Cliente)
Dentro del detalle de un cliente, crea una secci√≥n/tab para ver las transactions.
Tabla Datatable con: Fecha, Origen (API), Descripci√≥n, Monto (colorear verde si es income, rojo si es expense), Estado.
Bot√≥n de Acci√≥n: Incluye un bot√≥n visual "Exportar Excel" arriba de la tabla (solo el bot√≥n, la l√≥gica la har√© luego).
Bot√≥n Ver Detalle: Que permita ver el contenido del campo raw_data (JSON) en un modal o detalle expandible.
Nota de Estilo:
Usa componentes de Tailwind CSS limpios. El dise√±o debe ser profesional (estilo SaaS corporativo). Usa Alpine.js para interacciones simples (como abrir el modal de detalles del JSON).

## Etapa 8: Estado -> COMPLETADO ‚úÖ
- [x] Migraciones (`api_logs`, `transactions`).
- [x] Modelos y Relaciones (`ApiLog`, `Transaction`).
- [x] Dashboard T√©cnico (`/admin/api-dashboard`) con gr√°ficas y filtros.
- [x] Vista de Movimientos en Cliente.
- [x] Seeder de Datos de Prueba (`ApiLogTransactionSeeder`).